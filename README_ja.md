# simple cardgame server
ゲームプレイ系は未デバッグです。

オンライン対戦のトランプゲーム等を作成するためのマッチングサーバー兼ゲームサーバーです。山札や手札をサーバー側で管理するため、ポーカーのようなゲームでもチートを防ぐことができます。ゲームロジックはサーバー側には書かれていないため、クライアントプログラムの実装次第で様々なゲームを作成できます。

## 機能
- socket.ioを用いてクライアントとサーバー間の通信を行うため、双方向のリアルタイム通信が可能です。
- すべての通信はサーバーを経由するためNAT越えを考える必要がありません。
- 通信はJSONを用いて簡単なプロトコルに沿って行われます。
- マッチングは同じゲームIDを指定してマッチングを要求してきたクライアント同士を結びつける非常にシンプルなアルゴリズムです。ユーザーの登録もゲームIDの登録も必要ありません。
- サーバーが持っているゲームの情報は山札とプレイヤーごとの手札だけです。これらの情報をサーバーが管理することでP2P通信では防げない不正を防ぐことができます。また、必要最低限の情報しか管理していないため、様々なゲームに利用することができます。
- チャット機能があります。

## 制限
- 現在2人対戦にしか対応していません。
- まだ実装されている操作が多くないため作るのが困難なゲームもあります。実装されている操作は通信プロトコルのゲームプレイの項を参照してください。
- ゲーム終了後に別の試合を行うには、ブラウザの再読み込み等でサーバーとの通信を切断する必要があります。

## 用語
- 部屋
    - マッチングされたメンバーで構成されます。プレイヤー、山札、手札、ターンを管理しています。
- 山札
    - カードの配列です。各対戦ごとに1つの山札が用意され、プレイヤーはここからカードを引くことができます。初期状態では空の配列です。山札にカードを追加すると、サーバーがシャッフルを行います。
- 手札
    - 各プレイヤーが持っているカードの配列です。プレイヤーは手札の一部を他のプレイヤーに公開することができ、サーバーはそのプレイヤーが公開したカードが確かにそのプレイヤーの手札であることを検証します。初期状態では空の配列です。
- ターン
    - 操作を行えるプレイヤーはゲーム開始時に割り当てられるターンが現在のターンと一致しているプレイヤーのみです。各操作で次に操作を行うプレイヤーを指定するため、実際のゲームがこの順番に従う必要はありません。初期状態では0です。つまり最初に操作を行うのはターンが0のプレイヤーです。

## 通信プロトコル
socket.ioでサーバーと通信します。詳細については公式ドキュメントやネット上の記事を参照してください。
以下では送受信するイベント名とデータの形式のみ説明します。  
イベント名の頭についている`c2s_`, `s2c_`はそれぞれclient to serverとserver to clientの略です。

### マッチング要求
サーバーとの通信を確立したら最初に送るべきイベントです。新しい部屋を作るか、既存の部屋に入ります。

#### クライアントからサーバーへ  
- **イベント名:** `c2s_request-matching`
    
    **データ例:**
    ```json
    {
      "gameID": "iifcgffMcyFB2XZBwTP_G",
      "nickname": "dsajgiouawj"
    }
    ```
    **パラメーター:**
    
    | パラメーター | 値 | 必須 | 説明 |  
    |:---|:---|:---:|:---|  
    | `gameID`  | 任意の文字列| はい| 同じ`gameID`を指定したクライアントとマッチングします。他のゲームと被らないようランダムな文字列の使用を推奨します|
    | `nickname`| 任意の文字列| はい| ユーザー名                                                                                    |
    
#### サーバーからの応答
`s2c_error`, `s2c_created-room`, `s2c_joined-room`のいずれかのイベントが送られます。`s2c_joined-room`の場合は部屋の情報が送られます。

- **イベント名:** `s2c_error`
    
    **条件:**
    - 必須パラメーターが足りていない
    - すでにroomに入っているのに再びマッチング要求を送った
    - その他何らかのエラーが発生した
    
    **データ例:**  
    ```json
    {
      "message": "please specify gameID and nickname"
    }
    ```
    
- **イベント名:** `s2c_created-room`
    
    **条件:**
    - 指定した`gameID`でマッチングを待機しているクライアントがいなかった
    
    **データ例:**  
    ```json
    {}
    ```
    空のデータが送られます。
    
- **イベント名:** `s2c_joined-room`
    
    **条件:**
    - 指定した`gameID`でマッチングを待機しているクライアントがいた
    
    **データ例:**
    ```json
    {
      "playerList": ["Alice", "Bob"],
      "chatHistory": [
        {"from": "Alice", "message": "Hello"},
        {"from": "Bob", "message": "こんにちは"}
      ]
    }
    ```
    **パラメーター:**
    
    | パラメーター | 値 | 説明 |  
    |:---|:---|:---|  
    | `playerlist`   | 文字列の配列     | 既に部屋に入っているユーザー名の配列です。自身は含みません。                                                                 |
    | `chatHistory`| チャット情報の配列| 入室前にその部屋で交わされていたチャットの履歴です。送信元ユーザー名`from`と送信されたメッセージ`message`からなるチャット情報の配列です。|
    
    この時、すでに部屋に入っているクライアントには`s2c_show-in`イベントが送信されます。
    - **イベント名:** `s2c_show-in`
    
        **データ例:**
        ```json
        {
          "nickname": "dsajgiouawj"
        }
        ```
        
        **パラメーター:**
            
        | パラメーター | 値 | 説明 |  
        |:---|:---|:---|  
        | `nickname`   | 文字列| 新しく部屋に入ってきたクライアントのユーザー名|

### ゲーム開始
部屋に必要な人数(現在は2人で固定)が集まると、その部屋に入っているすべてのクライアントに対し、サーバーから`s2c_game-start`イベントが送られます。
ここでターンが割り当てられます。
- **イベント名:** `s2c_game-start`
    
    **データ例:**
    ```json
    {
      "turn": 0
    }
    ```
    
    **パラメーター:**
        
    | パラメーター | 値 | 説明 |  
    |:---|:---|:---|  
    | `turn`| 0から(対戦人数 - 1)までの整数| 部屋に入室している各クライアントに対して相異なる整数がランダムに割り当てられます。|
    
### ゲームプレイ
ゲーム開始後はゲームの流れに沿って各クライアントが`c2s_play`イベントをサーバーに送ります。このイベントを送れるのはゲーム開始時に割り当てられたターンが現在のターンと一致するクライアントのみです。操作者には`s2c_play_response`イベント、操作者以外には`s2c_play_broadcast`イベントがサーバーから送られます。
- **イベント名:** `c2s_play`
    **データ例:**
    ```json
    {
      "operation": "draw",
      "next": 1,
      "gameInfo": {}
    }
    ```
    
    **パラメーター:**
    
    | パラメーター | 値 | 必須 | 説明 |  
    |:---|:---|:---:|:---|  
    | `operation`  | `add-cards-to-deck`,`draw`,`draw-expose`,`discard-expose`,`pass`| はい| 操作の種類を表します。操作によっては他にも必須パラメーターがあります。詳細は各操作の説明を参照してください。|
    | `next`| 0から(対戦人数 - 1)までの整数| はい| 次に操作を行うプレイヤーのターン番号。自身を指定することも可能。                                                              |
    | `gameInfo`| 任意| いいえ| サーバーでは管理していないゲーム特有の情報。同じ部屋にいる操作者以外全員にそのまま送られます。                                                     |
    
    必須パラメーターが不足している場合、必須パラメーターの値が正しくない場合、操作ごとの`s2c_error`条件を満たした場合、ゲームが開始していない場合、プレイヤーに割り当てられているターンが現在のターンと一致しない場合、その他何らかのエラーが発生した場合は、`message`パラメーターを持つ`s2c_error`イベントが操作者に送られます。この場合各種操作の「操作者に送られる情報」「操作者以外に送られる情報」は送られません。
    #### 各種操作
    - `add-cards-to-deck`: 山札にカードを追加します。追加されたカードは既存の山札とともにシャッフルされます。ゲーム開始直後は山札が空なので通常この操作を行います。
        - 追加の必須パラメーター:
        
            | パラメーター | 値 | 必須 | 説明 |  
            |:---|:---|:---:|:---|  
            | `cards`  | 配列| はい| 要素の型は何でも構いません。要素数1でも配列にする必要があります。|
        - 操作者へ送られる情報: `c2s_play`イベントで送信されたものと同じ。
        - 操作者以外へ送られる情報: `c2s_play`イベントで送信されたものと同じ。
        - `s2c_error`条件
            - `cards`が配列でない
    - `draw`: 山札から1枚引き、手札に加えます。引いたカードは本人にしか知らされません。
        - 追加の必須パラメーター:なし
        - 操作者へ送られる情報: `c2s_play`イベントで送信された情報に加え、以下のパラメーターが送られます。

            | パラメーター | 値 | 説明 |  
            |:---|:---|:---|  
            | `card`  | 山札の要素のうち1つ| 山札から引いたカードです。この値は山札から取り除かれ、操作者の手札に加えられています。|
            
        - 操作者以外へ送られる情報: `c2s_play`イベントで送信されたものと同じ。
        - `s2c_error`条件
            - 山札にカードが存在しない。
    - `draw-expose`: 山札から1枚引き、手札に加えます。引いたカードは全員に知らされます。
        - 操作者以外へ送られる情報: `card`パラメーターが操作者以外にも送られます。
        
        それ以外は`draw`操作と同じです。
    - `discard-expose`: 手札から指定されたカードを1枚取り除きます。取り除いたカードは全員に知らされます。指定されたカードが手札の中に存在するかどうかはサーバー側で検証されます。
        - 追加の必須パラメーター:

            | パラメーター | 値 | 必須 | 説明 |  
            |:---|:---|:---:|:---|  
            | `card`  | 手札の要素の内1つ| はい| 指定されたカードは手札から除かれます。|
        - 操作者へ送られる情報: `c2s_play`イベントで送信されたものと同じ。 
        - 操作者以外へ送られる情報: `c2s_play`イベントで送信されたものと同じ。 
    - `pass`: 何もせず、ターンだけ変更します。
        - 追加の必須パラメーター:なし
        - 操作者へ送られる情報: `c2s_play`イベントで送信されたものと同じ。    
        - 操作者以外へ送られる情報: `c2s_play`イベントで送信されたものと同じ。 

### チャット
チャットはゲームが開始しているか否かに関わらず送信できます。後から部屋に入った人にも入室時にチャット履歴が送られます。
- **イベント名:** `c2s_chat`

    **データ例:**
    ```json
    {
      "message": "Hello!"
    }
    ```
    
    **パラメーター:**
    
    | パラメーター | 値 | 必須 | 説明 |  
    |:---|:---|:---:|:---|  
    | `message`  | 任意の文字列| はい| 送信するメッセージ|
    
    必須パラメーターが不足している場合、必須パラメーターの値が正しくない場合、その他何らかのエラーが発生した場合は、`message`パラメーターを持つ`s2c_error`イベントが送信者に送られます。この場合「送信者以外に送られる情報」は送られません。
    
サーバーから送信者以外へ以下の情報が送られます。送信者には何も送られません。

- **イベント名:** `s2c_chat`
 
    **データ例:**
    ```json
    {
      "from": "Alice",
      "message": "Hello"
    } 
    ```

    **パラメーター:**

    | パラメーター | 値 | 説明 |  
    |:---|:---|:---|  
    | `from`   | 文字列| 送信者のユーザー名(nickname)|
    | `message`| 文字列| 送信者が送ったメッセージ     |
